---
title: "Update Page"
author: "Alison Turner"
date: "2022-08-02"
output: pdf_document
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE)
library(tidyverse)
library(readxl)
library(lubridate)
library(ggplot2)
library(plotly)
library(htmlwidgets)
library(censusapi)
library(tigris)
library(sf)

# Functions for data processing
# These functions are used to clean ACS pulled data 

yeargeog <- function(year,state,vars){
  data.frame(year = year, 
             getCensus(name="acs/acs5",
                       vintage=year,
                       vars = vars,
                       key=key,
                       region = "tract:*",
                       regionin = paste0("state:",unique(fips_codes$state_code)[state])
             )
  )
  
}

fips_to_acs <- function(data){
  t <- left_join(data,fips_codes,by=c("state"="state_code","county"="county_code"))
  t
}


# defining the color scheme for Restore Justice
mypal <- c("#213159", "#3D6098","#F04B4C","#80475E","#FEC20E", "#b4b4b4")

cvi_colours = list(
  RJ_colors = c("#213159","#3D6098","#F04B4C","#80475E","#FEC20E", "#b4b4b4")
)

cvi_palettes = function(name, n, all_palettes = cvi_colours, type = c("discrete", "continuous")) {
  palette = all_palettes[[name]]
  if (missing(n)) {
    n = length(palette)
  }
  type = match.arg(type)
  out = switch(type,
               continuous = grDevices::colorRampPalette(palette)(n),
               discrete = palette[1:n]
  )
  structure(out, name = name, class = "palette")
}


cvi_palettes("RJ_colors", type = "discrete")


scale_colour_cvi_d = function(name) {
  ggplot2::scale_colour_manual(values = cvi_palettes(name,
                                                    type = "discrete"))
}

scale_fill_cvi_d = function(name) {
  ggplot2::scale_fill_manual(values = cvi_palettes(name,
                                                    type = "discrete"))
}



```


```{r read data}

#read in latest data 
latest_stock <- read_xls("Prison Stock Reports/June2022.xls",skip=5)

#clean footer rows (any observation without a name)
latest_stock <- drop_na(latest_stock,Name)

#clean column names for uniformity
###### Alison! Make sure that you have a check in here (number of columns and redirect)



names(latest_stock) <- gsub('[[:digit:]]+', '', names(latest_stock))
names(latest_stock) <- gsub("[[:punct:]]","",names(latest_stock))


##DOES NOT WORK ON 2022 data
# names(latest_stock) <- c("ID Number", "Name" ,"Birth Date","Sex", "Race",  "Veteran Status","Current Admission Date", "Admission Type" ,"Parent Institution", "Projected Mandatory Supervised Release Date", "Projected Discharge Date","Custody Date" ,"Sentence Date" , "Crime Class","Holding Offense" , "Sentence Years" ,"Sentence Months"  ,"Truth in Sentencing" ,"Sentencing County"  )

## 2022 data
names(latest_stock) <- c("ID Number", "Name" ,"Birth Date","Sex", "Race",  "Veteran Status","Current Admission Date", "Admission Type" ,"Parent Institution", "Projected Mandatory Supervised Release Date", "Projected Discharge Date","Custody Date" ,"Sentence Date" , "Crime Class","Holding Offense" ,"Holding Offense Category","Offense Type", "Sentence Years" ,"Sentence Months"  ,"Truth in Sentencing" ,"Sentencing County"  )


# Early stock files have changed institution names, create uniformity
latest_stock$`Parent Institution` <- gsub(" CC","",latest_stock$`Parent Institution`)
latest_stock$`Parent Institution`<- gsub("Southwestern IL","Southwestern Illinois",latest_stock$`Parent Institution`)

# Clean dates 
#### Alison! make sure this can take on the weird middle years 
datevars <- grepl("Date",names(latest_stock))

# for (i in 1:length(datevars[datevars==TRUE])){
#   latest_stock[,datevars][,i] <- as.Date(latest_stock[,datevars][,i])
# }


# Creation of year transform variables to calculate life sentence, Defacto Life Sentence, or SDP status 
latest_stock$yeartrans <- ifelse(grepl("^[[:digit:]]+$",latest_stock$`Sentence Years`),latest_stock$`Sentence Years`,NA)
latest_stock$yeartrans <- as.numeric(latest_stock$yeartrans)
latest_stock <- latest_stock %>% 
  mutate(age=year(Sys.Date())-year(`Birth Date`),
         life=ifelse(`Sentence Years`=="LIFE",1,(ifelse(yeartrans>49,"De Facto",0))),
         sdp=ifelse(`Sentence Years`=="SDP",1,0),
         "Sentence Age" = year(latest_stock$`Sentence Date`)-year(latest_stock$`Birth Date`),
         "Custody Age" = year(latest_stock$`Custody Date`)-year(latest_stock$`Birth Date`)) %>% select(-yeartrans)



latest_stock$`Sentence Years` <- as.numeric(latest_stock$`Sentence Years`)


#Calculation of admission minus custody variable
latest_stock$`Admission to Custody Time Days` <- difftime(latest_stock$`Current Admission Date`,latest_stock$`Custody Date`,units="days")

```

```{r ACS pull, include=FALSE}
#replace with a local census key 
key <- "095f223bd2d9dd69b8546222bde6c171c540da9b"

race_vars <- c("B01001A_001E","B01001B_001E","B01001C_001E","B01001D_001E","B01001E_001E","B01001F_001E","B01001G_001E","B01001H_001E","B01001I_001E")

acs5_race_17 <- getCensus(name = "acs/acs5",
                       vintage = 2017,
                       vars = race_vars,
                       key = key,
                       region="county:*",
                       regionin = "state:17")
acs5_race_17$year <- 2017

acs5_race_20 <- getCensus(name = "acs/acs5",
                          vintage = 2020,
                          vars = race_vars,
                          key = key,
                          region="county:*",
                          regionin = "state:17")
acs5_race_20$year <- 2020

acs5_race <- rbind(acs5_race_17,acs5_race_20)

acs5_race <- fips_to_acs(acs5_race)
acs5_race <- acs5_race %>% select (year,state_name,county.y,"B01001A_001E","B01001B_001E","B01001C_001E","B01001D_001E","B01001E_001E","B01001F_001E","B01001G_001E","B01001H_001E","B01001I_001E" )

names(acs5_race) <- c("year","state","county", 
                      "white alone",
                      "black alone",
                      "american indian or alaska native alone",
                      "asian alone",
                      "native hawaiian or pacific islander alone",
                      "some other race alone",
                      "two or more races",
                      "white alone, not hispanic or latino",
                      "hispanic or latino, any race category"
)


#transformation of data frame to align with IDOC data 
acs5_race$county <- str_remove(acs5_race$county," County")
acs5_race$total <- rowSums(acs5_race[,4:10])
acs5_race_perc <- data.frame(acs5_race[,1:3],lapply(acs5_race[,4:10],function(x) (x/acs5_race$total)*100))
acs5_race_perc$check <- rowSums(acs5_race_perc[,4:10])
15
IL_counties <- tigris::counties(state=17) %>%
  select(county = NAME,geometry) %>% 
  st_transform(4326) 

names(acs5_race_perc)[4:10] <- c("White","Black","American Indian","Asian","Native Hawaiian","Unknown","Bi-Racial")


ACS_IL <- acs5_race_perc %>% 
  select(-check) %>% 
  pivot_longer(cols = 4:10,names_to = "Race")


ACS_IL <- left_join(ACS_IL,IL_counties)

names(acs5_race)[4:10] <- c("White","Black","American Indian","Asian","Native Hawaiian","Unknown","Bi-Racial")


ACS_IL2 <-acs5_race %>% 
  pivot_longer(cols = 4:10,names_to = "Race") 

```

## Admission to Custody

This section explores the time between their current admission date and their custody date. In the first chart, we look at trends in custody time versus crime class depending on the sentence data of an individual. "This"Unclassified" persons, generally those who are not serving a traditional sentence at a correctional facility but re listed as a sexually dangerous person,  are the only group to have seen a significant decrease in time between admission and custody over the years. There are a few interesting groupings of downward trends from 1990 to the present on time between admission and custody. 

```{r Admission to Custody EDA}

## Double check outliers

ggplot(latest_stock)+
  geom_point(mapping=aes(x=`Sentence Date`,y=`Admission to Custody Time Days`))+
  geom_smooth(mapping=aes(x=`Sentence Date`,y=`Admission to Custody Time Days`))+
  facet_wrap(~`Crime Class`)

```


## Age
The median age for people serving in the Illinois Department of Corrections system is 31. We dive deeper into those who were sentenced before age 26 to either life or de facto life sentences. 
```{r Age EDA}

d26 <- latest_stock %>% filter(`Custody Age`<27)
d26_life <- d26[d26$life%in%c("1","De Facto"),]

Life_age <- latest_stock %>% filter(life%in%c("1","De Facto")) %>% group_by(`Custody Age`) %>% summarise(n())
sum(Life_age$`n()`[Life_age$`Custody Age`<26])/sum(Life_age$`n()`)


sum(Life_age$`n()`[Life_age$`Custody Age`<21])/sum(Life_age$`n()`)


l <- d26_life %>% group_by(sent_year=lubridate::floor_date(`Sentence Date`,"year")) %>% summarise(n())
sum(l$`n()`[l$`sent_year`>2004])/sum(l$`n()`)

black_youth <- d26_life %>% group_by(Race) %>% summarize(n())

ggplot(latest_stock) +
  aes(x = `Custody Age`) +
  geom_histogram(bins = 30L, fill = mypal[1]) +
  theme_minimal()+
  ggtitle("Age at sentence, all IDOC")

latest_stock %>%
 filter(`Crime Class` %in% c("Murder", "Class M")) %>%
 ggplot() +
  aes(x = `Sentence Age`) +
  geom_histogram(bins = 30L, fill = mypal[1]) +
  theme_minimal()+
  ggtitle("Age at sentence, Crime Class - Murder")

d26_life_race <- d26_life %>% group_by(`Sentence Age`,Race) %>% summarize(n=n()) %>% pivot_wider(names_from=Race,values_from = n)

ggplot(latest_stock) +
  aes(x = age) +
  geom_histogram(bins = 30L, fill = mypal[1]) +
  theme_minimal() +
  facet_wrap(vars(`Parent Institution`))

p1_data <- latest_stock %>% pivot_wider(names_from=`Parent Institution`,values_from = age)

p1 <- plot_ly(alpha = .6, data= p1_data) %>% 
  add_histogram(x=~Dixon, name="Dixon") %>%
  add_histogram(x=~`Western Illinois`, name="Western Illinois") %>%
  add_histogram(x=~Pontiac, name="Pontiac")%>%
  add_histogram(x=~Pinckneyville, name="Pinckneyville")%>%
  add_histogram(x=~Lawrence, name="Lawrence") %>%
  add_histogram(x=~Menard, name="Menard") %>%
  add_histogram(x=~`Illinois River`, name="Illinois River") %>%
  add_histogram(x=~Hill, name="Hill") %>%
  add_histogram(x=~Robinson, name="Robinson") %>%
  add_histogram(x=~Shawnee, name="Shawnee") %>%
  add_histogram(x=~Sheridan, name="Sheridan") %>%
  add_histogram(x=~`Big Muddy River`, name="Big Muddy River") %>%
  add_histogram(x=~`East Moline`, name="East Moline") %>%
  add_histogram(x=~Taylorville, name="Taylorville") %>%
  add_histogram(x=~Graham, name="Graham") %>%
  add_histogram(x=~Lincoln, name="Lincoln") %>%
  add_histogram(x=~Vienna, name="Vienna") %>%
  add_histogram(x=~`Joliet Treatment Center`, name="Joliet Treatment Center") %>%
  add_histogram(x=~Vandalia, name="Vandalia") %>%
  add_histogram(x=~Jacksonville, name="Jacksonville") %>%
  add_histogram(x=~`Southwestern Illinois`, name="Southwestern Illinois") %>%
  add_histogram(x=~`Kewanee Reentry Center`, name="Kewanee Reentry Center") %>%
  add_histogram(x=~Logan, name="Logan") %>%
  add_histogram(x=~Decatur, name="Decatur")
  
  
```

When looking at the distribution of youth life and de facto life sentences by race, outcomes are overwhelmingly skewed toward young black men. 


```{r Admit Age by Race}

# About 96 percent of youth life and de facto life sentences are for homicide-related offenses. 
youthhom <- length(latest_stock$life[latest_stock$life %in% c("De Facto", 1) & str_detect(latest_stock$`Holding Offense`,"MURDER")])/length(latest_stock$life[latest_stock$life %in% c("De Facto", 1)])
paste(youthhom,"percent of youth life and de facto life sentences are for homicide-related offenses")

fig <- plot_ly(d26_life_race, x = ~`Sentence Age`,y=~Black, type = 'bar', name = 'Black') %>%
  add_trace(y = ~White, name = 'White') %>%
  add_trace(y = ~Hispanic, name = 'Hispanic') 
  # add_trace(y = ~`Bi-Racial`, name = 'Bi-Racial') %>%
  # add_trace(y = ~`American Indian`, name = 'American Indian') %>%
  # add_trace(y = ~`Asian`, name = 'Asian') %>%
  # add_trace(y = ~`Unknown`, name = 'Unknown')

fig <- fig %>% layout(yaxis = list(title = 'Count'), barmode = 'group')
fig
```
In looking at the distribution by geography, ninety-five of Illinois’s 102 counties have sentenced at least one person to life or de facto life (among the people still serving these sentences), seventy eight of those counties have sentenced at least one person to life or de facto life before their 26th birthday.Sixty two percent of the people currently serving  life or de facto life sentences were sentenced in Cook county. 

The map below shows the number of people serving youth life or de facto life sentences in each county. Counties are shaded according to the difference in county population of black individuals versus the youth life or de facto life population of black individuals lighter shading indicates a larger difference between those serving youth life and de facto life sentences vs the total population. 
```{r Life by county}
life_counties <- latest_stock[latest_stock$life %in% c("De Facto", 1),]
life_counties <- unique(life_counties$`Sentencing County`)

# ggplot(d26_life)+
#   geom_histogram(mapping=aes(x=`Sentence Age`))

d26_counties <- d26_life%>% group_by(`Sentencing County`) %>% summarise(number=n()) 
county_life <- d26_life%>% group_by(`Sentencing County`,Race) %>% summarise(number=n()) %>% mutate("IDOC percent"=(number/sum(number))*100)

county_life2 <- left_join(county_life,ACS_IL[ACS_IL$year==2020,],by=c("Sentencing County"="county","Race"="Race"))
county_life2 <- county_life2 %>% mutate(diff=`IDOC percent`-value)

county_life_sums <- county_life2 %>%
  group_by(`Sentencing County`) %>%
  summarise(sum=sum(number)) 
county_life_sums <- distinct(left_join(county_life_sums,county_life2[c(1,8)]))

ggplot()+
  geom_sf(data=IL_counties,fill="white")+
  geom_sf(data=county_life2[county_life2$Race=="Black",], mapping=aes(fill=diff,geometry=geometry))+
  geom_sf_text(data=county_life_sums,mapping = aes(label=sum,geometry=geometry),color="grey",size=3)+
  theme_classic()+
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
        axis.text.y=element_blank(),axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank())+
  labs(fill="")


```
To simplify this map, in a way, we highlight only counties that have over double the percent population of black people in prison as in that county -- as you can see, the information becomes shocking in that over half the counties in Illinois have a black percent population incarcerated over double that of the county population itself. 

```{r}

race_counties <- latest_stock%>% group_by(`Sentencing County`) %>% summarise(number=n()) 
tst <- latest_stock%>% group_by(`Sentencing County`,Race) %>% summarise(count=n()) %>% mutate("IDOC percent"=(count/sum(count))*100)
ACS_IL2$county <- str_remove(ACS_IL2$county," County")


county_life2 <- left_join(tst,ACS_IL2[ACS_IL2$year==2020,],by=c("Sentencing County"="county","Race"="Race"))
county_life2 <-county_life2%>%mutate("County percent"=(value/total)*100)
county_life2 <- county_life2 %>% mutate(diff=`IDOC percent`/`County percent`)

ACS_IL_edit <- ACS_IL[ACS_IL$year==2020,]
ACS_IL_edit$county <- str_remove(ACS_IL_edit$county," County")
county_life2 <- left_join(county_life2,ACS_IL_edit,by=c("Sentencing County"="county","Race"="Race"))

# county_life_sums <- county_life2 %>%
#   group_by(`Sentencing County`) %>%
#   summarise(sum=sum(number)) 
# county_life_sums <- distinct(left_join(county_life_sums,county_life2[c(1,8)]))

ggplot()+
  geom_sf(data=IL_counties,fill="white")+
  geom_sf(data=county_life2[county_life2$Race=="Black" & county_life2$diff>2,], mapping=aes(geometry=geometry),fill="orange")+
  geom_sf_text(data=county_life_sums,mapping = aes(label=sum,geometry=geometry),color="dark blue",size=2)+
  theme_classic()+
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
        axis.text.y=element_blank(),axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank())+
  labs(fill="")


```

